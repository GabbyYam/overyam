{"title":"JDK ç¼“å­˜æ¸…å•","slug":"ç¼“å­˜æ¸…å•","date":"2020-03-01T06:56:02.000Z","updated":"2020-03-01T09:45:54.196Z","comments":true,"path":"api/articles/ç¼“å­˜æ¸…å•.json","excerpt":"Abstractï¼šç®€å•æ•´ç†Javaä¸­å‡ºç°çš„å„ç§ç¼“å­˜","covers":null,"content":"<link rel=\"stylesheet\" type=\"text/css\" href=\"https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css\"><div class=\".article-gallery\" <p><strong>Abstract</strong>ï¼šç®€å•æ•´ç†<code>Java</code>ä¸­å‡ºç°çš„å„ç§ç¼“å­˜<p></p>\n<a id=\"more\"></a>\n<h2 id=\"ä»€ä¹ˆä¸œè¥¿éœ€è¦ç¼“å­˜ï¼Ÿ\">ä»€ä¹ˆä¸œè¥¿éœ€è¦ç¼“å­˜ï¼Ÿ</h2>\n<p>ç¼“å­˜çš„ä¸€èˆ¬éƒ½æ˜¯å¯¹è±¡ï¼Œå³åœ¨<strong>å †</strong>ä¸Šå­˜å‚¨çš„æ•°æ®ï¼Œå®ƒä»¬å…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>\n<ul>\n<li>æ•°æ®é‡å°</li>\n<li>éœ€è¦é¢‘ç¹è®¿é—®è¯»å–</li>\n</ul>\n<h2 id=\"ç¼“å­˜çš„æ—¶æœº\">ç¼“å­˜çš„æ—¶æœº</h2>\n<p>æ ¹æ®ä¸åŒç±»å‹çš„ç¼“å­˜åˆ†ç±»è®¨è®º</p>\n<h1 id=\"åˆå§‹åŒ–ç¼“å­˜ï¼šåŸºæœ¬æ•°æ®ç±»å‹ç¼“å­˜æ± \">åˆå§‹åŒ–ç¼“å­˜ï¼šåŸºæœ¬æ•°æ®ç±»å‹ç¼“å­˜æ± </h1>\n<p>Javaä¸­çš„åŸºæœ¬æ•°æ®ç±»å‹çš„åŒ…è£…ç±»ï¼Œè¯¸å¦‚<code>Integer</code>ã€<code>Long</code>ã€<code>Short</code>ï¼Œå‡è®¾æœ‰å¯¹åº”çš„ç¼“å­˜æ± </p>\n<p>ç¼“å­˜çš„æ—¶æœºæ˜¯åŒ…è£…ç±»è¢«åŠ è½½è¿›å†…å­˜æ—¶ï¼Œç¼“å­˜ä»£ç å†™åœ¨å¯¹åº”åŒ…è£…ç±»çš„<code>static</code>å—ä¸­ï¼Œä»¥<code>Integer</code>ä¸ºä¾‹</p>\n<pre><code class=\"language-java\">static final int low = -128;\nstatic final int high;\nstatic final Integer cache[];\n\n//ç¼“å­˜äº†-128 ~ 127 ä¹‹é—´çš„æ•°\nstatic {\n    // high value may be configured by property\n    int h = 127;\n    String integerCacheHighPropValue =\n        sun.misc.VM.getSavedProperty(&quot;java.lang.Integer.IntegerCache.high&quot;);\n    if (integerCacheHighPropValue != null) {\n        try {\n            int i = parseInt(integerCacheHighPropValue);\n            i = Math.max(i, 127);\n            // Maximum array size is Integer.MAX_VALUE ï¼š å¦‚æœç¼“å­˜æ± å¤§å°æŒ‡å®šæ¯”127å¤§ï¼Œå°±ä¼šæ‰©å¤§ç¼“å­˜æ± \n            h = Math.min(i, Integer.MAX_VALUE - (-low) -1);\n        } catch( NumberFormatException nfe) {\n            // If the property cannot be parsed into an int, ignore it.\n        }\n    }\n    high = h;\n\n    cache = new Integer[(high - low) + 1]; //new å‡ºç¼“å­˜\n    int j = low;\n    for(int k = 0; k &lt; cache.length; k++)\n        cache[k] = new Integer(j++);\n\n    // range [-128, 127] must be interned (JLS7 5.1.7)\n    assert IntegerCache.high &gt;= 127;\n}\n\n</code></pre>\n<h2 id=\"å…¶ä»–åŒ…è£…ç±»çš„é»˜è®¤ç¼“å­˜èŒƒå›´ï¼š\">å…¶ä»–åŒ…è£…ç±»çš„é»˜è®¤ç¼“å­˜èŒƒå›´ï¼š</h2>\n<p>ï¼ˆ<strong>ä½†æ˜¯æ³¨æ„ä¸€ä¸‹ï¼šè¿™ä¸ªç¼“å­˜èŒƒå›´å¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥é€šè¿‡è°ƒæ•´JVMå‚æ•° XX:AutoBoxCacheMax = &lt; size &gt; æ¥ä¿®æ”¹ç¼“å­˜æ± çš„å¤§å°</strong>ï¼‰</p>\n<ul>\n<li>boolean values true and false</li>\n<li>all byte values</li>\n<li>short values between -128 and 127</li>\n<li>int values between -128 and 127</li>\n<li>char in the range \\u0000 to \\u007F</li>\n</ul>\n<p>â€‹</p>\n<h1 id=\"æ‡’ç¼“å­˜ï¼šString-Pool\">æ‡’ç¼“å­˜ï¼šString Pool</h1>\n<p>String Poolæœ¬è´¨ä¸Šæ˜¯<strong>å¸¸é‡æ± </strong>ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è®¤ä¸ºå®ƒæ˜¯ç¼“å­˜ï¼Œï¼ˆ<strong>å¦å¤–æ³¨æ„ä¸€ä¸‹</strong>ï¼šjdk7åŠä»¥å‰ï¼ŒString Pooléƒ½æ˜¯åœ¨<strong>Perm</strong>å³æ°¸ä¹…ä»£ï¼Œè€Œä¸æ˜¯å †ä¸Šï¼Œè¿™é‡Œä¸ä½œè®¨è®ºï¼‰</p>\n<p><strong>Stringçš„ä¸å˜æ€§æ”¯æŒäº†String Poolçš„å®ç°ï¼ˆfinalä¿®é¥°ç¬¦ï¼‰</strong>ï¼š</p>\n<ul>\n<li>ç”±äºhashå€¼ä¸å˜ï¼Œå¦‚æœç¼“å­˜ä¸­å­˜åœ¨â€œabaâ€å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡hashç›´æ¥å¼•ç”¨åˆ°è¯¥å¯¹è±¡ï¼Œè€Œä¸æ˜¯é‡æ–°<strong>new</strong></li>\n<li>å¦å¤–ä¸å˜æ€§é—´æ¥ä½¿Stringå˜ä¸º<strong>çº¿ç¨‹å®‰å…¨</strong>çš„ç±»</li>\n</ul>\n<pre><code class=\"language-java\">String s1 = new String(&quot;aaa&quot;);\nString s2 = new String(&quot;aaa&quot;);\nSystem.out.println(s1 == s2);           // false\nString s3 = s1.intern();\nString s4 = s1.intern();\nSystem.out.println(s3 == s4);           // true\n</code></pre>\n<h2 id=\"intern-æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ\">intern()æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ<sup class=\"footnote-ref\"><a href=\"#fn1\" id=\"fnref1\">[1]</a></sup></h2>\n<ul>\n<li>\n<p>å¦‚æœString Poolä¸­å·²ç»å­˜åœ¨è¯¥å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›ï¼Œå¦åˆ™æ·»åŠ è¿›å¸¸é‡æ± åè¿”å›ï¼ˆ<strong>ç¼“å­˜åˆå§‹åŒ–</strong>ï¼‰</p>\n</li>\n<li>\n<p>æ ¹æ®openjdkï¼Œæœ¬è´¨ä¸Šæœ€åæ˜¯è°ƒç”¨äº†c++ä¸­çš„<code>StringTable::intern</code>æ–¹æ³•</p>\n<pre><code class=\"language-c++\">oop StringTable::intern(Handle string_or_null, jchar* name,  \n                        int len, TRAPS) {  \n    unsigned int hashValue = java_lang_String::hash_string(name, len); //è®¡ç®—hashå€¼ \n    int index = the_table()-&gt;hash_to_index(hashValue);                 //è®¡ç®—hashç´¢å¼•\n    oop string = the_table()-&gt;lookup(index, name, len, hashValue);     //æŸ¥æ‰¾å¸¸é‡æ± \n    // Found  \n    if (string != NULL) return string;  \n    // Otherwise, add to symbol to table  \n    return the_table()-&gt;basic_add(index, string_or_null, name, len,    //å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å…ˆåŠ å…¥å¸¸é‡æ± \n                                  hashValue, CHECK_NULL);  \n}\n</code></pre>\n</li>\n<li>\n<p><code>intern()</code>çš„<mark>æ­£ç¡®ä½¿ç”¨å§¿åŠ¿</mark></p>\n<pre><code class=\"language-java\">for (int i = 0; i &lt; MAX; i++) {\n    //arr[i] = new String(String.valueOf(DB_DATA[i % DB_DATA.length]));\n    arr[i] = new String(String.valueOf(DB_DATA[i % DB_DATA.length])).intern();\n}\n</code></pre>\n<p><strong>å½“ç„¶ï¼Œå‰ææ˜¯ç¼“å­˜çš„ç›®æ ‡å¤§å¤šéƒ½æ˜¯ä¸å˜çš„ï¼Œå¦‚æœç¼“å­˜çš„Stringå¤§é‡å˜åŠ¨ï¼Œå°±ä¼šå¯¹String Poolé€ æˆå·¨å¤§çš„å‹åŠ›</strong></p>\n</li>\n</ul>\n<h1 id=\"æœªå®Œå¾…ç»­â€¦çŸ¥é“äº†æ–°çš„å†è¡¥å……å§â€‹ï¼ğŸ•Š\">æœªå®Œå¾…ç»­â€¦çŸ¥é“äº†æ–°çš„å†è¡¥å……å§â€‹ï¼ğŸ•Š</h1>\n<hr class=\"footnotes-sep\">\n<section class=\"footnotes\">\n<ol class=\"footnotes-list\">\n<li id=\"fn1\" class=\"footnote-item\"><p><a href=\"https://tech.meituan.com/2014/03/06/in-depth-understanding-string-intern.html\" target=\"_blank\" rel=\"noopener\">æ·±å…¥è§£æString#intern</a> <a href=\"#fnref1\" class=\"footnote-backref\">â†©ï¸</a></p>\n</li>\n</ol>\n</section>\n</div><script src=\"https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js\"></script><script>if (typeof lightGallery !== 'undefined') {\n        var options = {\n            selector: '.gallery-item'\n        };\n        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);\n        }</script>","more":"<h2 id=\"ä»€ä¹ˆä¸œè¥¿éœ€è¦ç¼“å­˜ï¼Ÿ\">ä»€ä¹ˆä¸œè¥¿éœ€è¦ç¼“å­˜ï¼Ÿ</h2>\n<p>ç¼“å­˜çš„ä¸€èˆ¬éƒ½æ˜¯å¯¹è±¡ï¼Œå³åœ¨<strong>å †</strong>ä¸Šå­˜å‚¨çš„æ•°æ®ï¼Œå®ƒä»¬å…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>\n<ul>\n<li>æ•°æ®é‡å°</li>\n<li>éœ€è¦é¢‘ç¹è®¿é—®è¯»å–</li>\n</ul>\n<h2 id=\"ç¼“å­˜çš„æ—¶æœº\">ç¼“å­˜çš„æ—¶æœº</h2>\n<p>æ ¹æ®ä¸åŒç±»å‹çš„ç¼“å­˜åˆ†ç±»è®¨è®º</p>\n<h1 id=\"åˆå§‹åŒ–ç¼“å­˜ï¼šåŸºæœ¬æ•°æ®ç±»å‹ç¼“å­˜æ± \">åˆå§‹åŒ–ç¼“å­˜ï¼šåŸºæœ¬æ•°æ®ç±»å‹ç¼“å­˜æ± </h1>\n<p>Javaä¸­çš„åŸºæœ¬æ•°æ®ç±»å‹çš„åŒ…è£…ç±»ï¼Œè¯¸å¦‚<code>Integer</code>ã€<code>Long</code>ã€<code>Short</code>ï¼Œå‡è®¾æœ‰å¯¹åº”çš„ç¼“å­˜æ± </p>\n<p>ç¼“å­˜çš„æ—¶æœºæ˜¯åŒ…è£…ç±»è¢«åŠ è½½è¿›å†…å­˜æ—¶ï¼Œç¼“å­˜ä»£ç å†™åœ¨å¯¹åº”åŒ…è£…ç±»çš„<code>static</code>å—ä¸­ï¼Œä»¥<code>Integer</code>ä¸ºä¾‹</p>\n<pre><code class=\"language-java\">static final int low = -128;\nstatic final int high;\nstatic final Integer cache[];\n\n//ç¼“å­˜äº†-128 ~ 127 ä¹‹é—´çš„æ•°\nstatic {\n    // high value may be configured by property\n    int h = 127;\n    String integerCacheHighPropValue =\n        sun.misc.VM.getSavedProperty(&quot;java.lang.Integer.IntegerCache.high&quot;);\n    if (integerCacheHighPropValue != null) {\n        try {\n            int i = parseInt(integerCacheHighPropValue);\n            i = Math.max(i, 127);\n            // Maximum array size is Integer.MAX_VALUE ï¼š å¦‚æœç¼“å­˜æ± å¤§å°æŒ‡å®šæ¯”127å¤§ï¼Œå°±ä¼šæ‰©å¤§ç¼“å­˜æ± \n            h = Math.min(i, Integer.MAX_VALUE - (-low) -1);\n        } catch( NumberFormatException nfe) {\n            // If the property cannot be parsed into an int, ignore it.\n        }\n    }\n    high = h;\n\n    cache = new Integer[(high - low) + 1]; //new å‡ºç¼“å­˜\n    int j = low;\n    for(int k = 0; k &lt; cache.length; k++)\n        cache[k] = new Integer(j++);\n\n    // range [-128, 127] must be interned (JLS7 5.1.7)\n    assert IntegerCache.high &gt;= 127;\n}\n\n</code></pre>\n<h2 id=\"å…¶ä»–åŒ…è£…ç±»çš„é»˜è®¤ç¼“å­˜èŒƒå›´ï¼š\">å…¶ä»–åŒ…è£…ç±»çš„é»˜è®¤ç¼“å­˜èŒƒå›´ï¼š</h2>\n<p>ï¼ˆ<strong>ä½†æ˜¯æ³¨æ„ä¸€ä¸‹ï¼šè¿™ä¸ªç¼“å­˜èŒƒå›´å¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥é€šè¿‡è°ƒæ•´JVMå‚æ•° XX:AutoBoxCacheMax = &lt; size &gt; æ¥ä¿®æ”¹ç¼“å­˜æ± çš„å¤§å°</strong>ï¼‰</p>\n<ul>\n<li>boolean values true and false</li>\n<li>all byte values</li>\n<li>short values between -128 and 127</li>\n<li>int values between -128 and 127</li>\n<li>char in the range \\u0000 to \\u007F</li>\n</ul>\n<p>â€‹</p>\n<h1 id=\"æ‡’ç¼“å­˜ï¼šString-Pool\">æ‡’ç¼“å­˜ï¼šString Pool</h1>\n<p>String Poolæœ¬è´¨ä¸Šæ˜¯<strong>å¸¸é‡æ± </strong>ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è®¤ä¸ºå®ƒæ˜¯ç¼“å­˜ï¼Œï¼ˆ<strong>å¦å¤–æ³¨æ„ä¸€ä¸‹</strong>ï¼šjdk7åŠä»¥å‰ï¼ŒString Pooléƒ½æ˜¯åœ¨<strong>Perm</strong>å³æ°¸ä¹…ä»£ï¼Œè€Œä¸æ˜¯å †ä¸Šï¼Œè¿™é‡Œä¸ä½œè®¨è®ºï¼‰</p>\n<p><strong>Stringçš„ä¸å˜æ€§æ”¯æŒäº†String Poolçš„å®ç°ï¼ˆfinalä¿®é¥°ç¬¦ï¼‰</strong>ï¼š</p>\n<ul>\n<li>ç”±äºhashå€¼ä¸å˜ï¼Œå¦‚æœç¼“å­˜ä¸­å­˜åœ¨â€œabaâ€å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡hashç›´æ¥å¼•ç”¨åˆ°è¯¥å¯¹è±¡ï¼Œè€Œä¸æ˜¯é‡æ–°<strong>new</strong></li>\n<li>å¦å¤–ä¸å˜æ€§é—´æ¥ä½¿Stringå˜ä¸º<strong>çº¿ç¨‹å®‰å…¨</strong>çš„ç±»</li>\n</ul>\n<pre><code class=\"language-java\">String s1 = new String(&quot;aaa&quot;);\nString s2 = new String(&quot;aaa&quot;);\nSystem.out.println(s1 == s2);           // false\nString s3 = s1.intern();\nString s4 = s1.intern();\nSystem.out.println(s3 == s4);           // true\n</code></pre>\n<h2 id=\"intern-æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ\">intern()æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ<sup class=\"footnote-ref\"><a href=\"#fn1\" id=\"fnref1\">[1]</a></sup></h2>\n<ul>\n<li>\n<p>å¦‚æœString Poolä¸­å·²ç»å­˜åœ¨è¯¥å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›ï¼Œå¦åˆ™æ·»åŠ è¿›å¸¸é‡æ± åè¿”å›ï¼ˆ<strong>ç¼“å­˜åˆå§‹åŒ–</strong>ï¼‰</p>\n</li>\n<li>\n<p>æ ¹æ®openjdkï¼Œæœ¬è´¨ä¸Šæœ€åæ˜¯è°ƒç”¨äº†c++ä¸­çš„<code>StringTable::intern</code>æ–¹æ³•</p>\n<pre><code class=\"language-c++\">oop StringTable::intern(Handle string_or_null, jchar* name,  \n                        int len, TRAPS) {  \n    unsigned int hashValue = java_lang_String::hash_string(name, len); //è®¡ç®—hashå€¼ \n    int index = the_table()-&gt;hash_to_index(hashValue);                 //è®¡ç®—hashç´¢å¼•\n    oop string = the_table()-&gt;lookup(index, name, len, hashValue);     //æŸ¥æ‰¾å¸¸é‡æ± \n    // Found  \n    if (string != NULL) return string;  \n    // Otherwise, add to symbol to table  \n    return the_table()-&gt;basic_add(index, string_or_null, name, len,    //å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å…ˆåŠ å…¥å¸¸é‡æ± \n                                  hashValue, CHECK_NULL);  \n}\n</code></pre>\n</li>\n<li>\n<p><code>intern()</code>çš„<mark>æ­£ç¡®ä½¿ç”¨å§¿åŠ¿</mark></p>\n<pre><code class=\"language-java\">for (int i = 0; i &lt; MAX; i++) {\n    //arr[i] = new String(String.valueOf(DB_DATA[i % DB_DATA.length]));\n    arr[i] = new String(String.valueOf(DB_DATA[i % DB_DATA.length])).intern();\n}\n</code></pre>\n<p><strong>å½“ç„¶ï¼Œå‰ææ˜¯ç¼“å­˜çš„ç›®æ ‡å¤§å¤šéƒ½æ˜¯ä¸å˜çš„ï¼Œå¦‚æœç¼“å­˜çš„Stringå¤§é‡å˜åŠ¨ï¼Œå°±ä¼šå¯¹String Poolé€ æˆå·¨å¤§çš„å‹åŠ›</strong></p>\n</li>\n</ul>\n<h1 id=\"æœªå®Œå¾…ç»­â€¦çŸ¥é“äº†æ–°çš„å†è¡¥å……å§â€‹ï¼ğŸ•Š\">æœªå®Œå¾…ç»­â€¦çŸ¥é“äº†æ–°çš„å†è¡¥å……å§â€‹ï¼ğŸ•Š</h1>\n<hr class=\"footnotes-sep\">\n<section class=\"footnotes\">\n<ol class=\"footnotes-list\">\n<li id=\"fn1\" class=\"footnote-item\"><p><a href=\"https://tech.meituan.com/2014/03/06/in-depth-understanding-string-intern.html\" target=\"_blank\" rel=\"noopener\">æ·±å…¥è§£æString#intern</a> <a href=\"#fnref1\" class=\"footnote-backref\">â†©ï¸</a></p>\n</li>\n</ol>\n</section>\n<script src=\"https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js\"></script><script>if (typeof lightGallery !== 'undefined') {\n        var options = {\n            selector: '.gallery-item'\n        };\n        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);\n        }</script>","categories":[{"name":"Java","path":"api/categories/Java.json"}],"tags":[{"name":"cache","path":"api/tags/cache.json"}]}