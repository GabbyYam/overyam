<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="github.com/GabbyYam/overyam/favicon.png" />
    

    <title>
        
          NoSQL &amp; Others/Redis-Application - Overyam
        
    </title>

    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="github.com/GabbyYam/overyam/css/book.css">

    
<script src="github.com/GabbyYam/overyam/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

<meta name="generator" content="Hexo 4.2.0"></head>

<body>

<div class="book-container">
  <div class="book-sidebar">
    <div class="book-brand">
  <a href="github.com/GabbyYam/overyam/">
    <img src="github.com/GabbyYam/overyam/favicon.png">
    <span>OVERYAM</span>
  </a>
</div>
    <div class="book-menu">
  
</div>


<script src="github.com/GabbyYam/overyam/js/book-menu.js"></script>

  </div>

  <div class="off-canvas-content">
    <div class="columns">
      <div class="column col-10 col-lg-12">
        <div class="book-navbar">
          <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

        </div>
        <div class="book-content">
          <div class="book-post">
  <p>[TOC]</p>
<h1 id="应用一：分布式锁（Distributed-Lock）"><a href="#应用一：分布式锁（Distributed-Lock）" class="headerlink" title="应用一：分布式锁（Distributed Lock）"></a>应用一：分布式锁（Distributed Lock）</h1><ul>
<li><p><strong>问题来源：</strong>并发情况下，读取和修改保存这两步并不满足原子性，从而需要分布式锁来进行限制</p>
</li>
<li><p><strong>问题本质：</strong>在Redis中占个坑，防止其他进程跑进来</p>
</li>
<li><pre><code class="sql">&gt; setnx lock ex k true --保证了expire和setnx的原子性,不适用于长任务
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- &#96;&#96;&#96;java</span><br><span class="line">  &#x2F;&#x2F;可重入锁</span><br><span class="line">  public class RedisWithReentrantLock &#123;</span><br><span class="line">      private ThreadLocal&lt;Map&gt; lockers &#x3D; new ThreadLocal&lt;&gt;();</span><br><span class="line">      private Jedis jedis;</span><br><span class="line">      public RedisWithReentrantLock(Jedis jedis) &#123;</span><br><span class="line">          this.jedis &#x3D; jedis;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      private boolean _lock(String key) &#123; 					&#x2F;&#x2F;加锁+自动过期</span><br><span class="line">          return jedis.set(key, &quot;&quot;, &quot;nx&quot;, &quot;ex&quot;, 5L) !&#x3D; null;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      private void _unlock(String key) &#123; 						&#x2F;&#x2F;解锁</span><br><span class="line">          jedis.del(key);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      private Map &lt;String, Integer&gt; currentLockers() &#123; 		</span><br><span class="line">          Map &lt;String, Integer&gt; refs &#x3D; lockers.get();</span><br><span class="line">          if (refs !&#x3D; null) &#123;</span><br><span class="line">              return refs;</span><br><span class="line">          &#125;</span><br><span class="line">          lockers.set(new HashMap&lt;&gt;());</span><br><span class="line">          return lockers.get();</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      public boolean lock(String key) &#123;</span><br><span class="line">          Map refs &#x3D; currentLockers();</span><br><span class="line">          Integer refCnt &#x3D; refs.get(key);</span><br><span class="line">          if (refCnt !&#x3D; null) &#123;</span><br><span class="line">              refs.put(key, refCnt + 1);</span><br><span class="line">              return true;</span><br><span class="line">          &#125;</span><br><span class="line">          boolean ok &#x3D; this._lock(key);</span><br><span class="line">          if (!ok) &#123;</span><br><span class="line">              return false;</span><br><span class="line">          &#125;</span><br><span class="line">          refs.put(key, 1);</span><br><span class="line">          return true;</span><br><span class="line">      &#125;</span><br><span class="line">      public boolean unlock(String key) &#123;</span><br><span class="line">          Map refs &#x3D; currentLockers();</span><br><span class="line">          Integer refCnt &#x3D; refs.get(key);</span><br><span class="line">          if (refCnt &#x3D;&#x3D; null) &#123;</span><br><span class="line">              return false;</span><br><span class="line">          &#125;</span><br><span class="line">          refCnt -&#x3D; 1;</span><br><span class="line">          if (refCnt &gt; 0) &#123;</span><br><span class="line">              refs.put(key, refCnt);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">              refs.remove(key);</span><br><span class="line">              this ._unlock(key);</span><br><span class="line">          &#125;</span><br><span class="line">          return true;</span><br><span class="line">      &#125;</span><br><span class="line">      public static void main(String[] args) &#123;</span><br><span class="line">          Jedis jedis &#x3D; new Jedis();</span><br><span class="line">          RedisWithReentrantLock redis &#x3D; new RedisWithReentrantLock(jedis);</span><br><span class="line">          System.out.println(redis.lock(&quot;codehole&quot;));</span><br><span class="line">          System.out.println(redis.lock(&quot;codehole&quot;));</span><br><span class="line">          System.out.println(redis.unlock(&quot;codehole&quot;));</span><br><span class="line">          System.out.println(redis.unlock(&quot;codehole&quot;));</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


</code></pre>
</li>
</ul>
<h1 id="应用二：延时队列（Delay-Queue）"><a href="#应用二：延时队列（Delay-Queue）" class="headerlink" title="应用二：延时队列（Delay Queue）"></a>应用二：延时队列（Delay Queue）</h1><ul>
<li><p>相比<code>rabbitMQ</code>等专业消息队列来说实现简单方便一些</p>
</li>
<li><p>直接使用<code>Redis</code>自带的<code>list</code>来实现</p>
</li>
<li><pre><code class="sql"></code></pre>
</li>
</ul>

</div>


  <div class="book-comments">
    




  </div>



<script src="github.com/GabbyYam/overyam/js/book-post.js"></script>

        </div>
      </div>
      <div class="column col-2 hide-lg">
        <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure
          class="avatar avatar-lg"
          data-initial="G"
          style="background-color: #3b4351;">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>GabbyYam</div>
      <div>2020-02-25</div>
    </div>
  </div>

  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="github.com/GabbyYam/overyam/js/book-toc.js"></script>

</div>
      </div>
    </div>
  </div>
  
  <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>

</body>
</html>


<script src="github.com/GabbyYam/overyam/js/book.js"></script>
